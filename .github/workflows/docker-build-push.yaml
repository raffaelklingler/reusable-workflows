name: Docker Build and Push

on:
  workflow_call:
    inputs:
      context:
        description: Context path to start build from
        required: false
        type: string
      dockerfile:
        description: Dockerfile to use, relative to context path
        required: false
        type: string
      images:
        description: List of images to push
        required: false
        type: string
        default: |
          ghcr.io/${{ github.repository }}
      pr-comment:
        description: Whether to create a PR comment with pushed image tags
        required: false
        default: true
        type: boolean
      push:
        description: Whether to push image tags
        required: false
        type: boolean
        default: true
      tag-rules:
        # https://github.com/marketplace/actions/docker-metadata-action#tags-input
        description: Determine image tags based on a key-value pair list in CSV format
        required: false
        type: string
        # create image tag "stable-<date>-<commit-hash>" on push to default branch
        # create image tag "latest" on push to default branch
        # create image tag "gha-<gha-run-id>" on PR
        # create image tag "pr-<pr-id>" on PR
        default: |
          type=raw,value=stable-{{date 'YYYYMMDD'}}-{{sha}},enable={{is_default_branch}},priority=300
          type=raw,value=latest,enable={{is_default_branch}},priority=100
          type=raw,value=gha-${{ github.run_id }},enable=${{github.event_name == 'pull_request'}},priority=200
          type=ref,event=pr,priority=100
    outputs:
      image:
        description: Resulting image which can be used in dependent jobs
        value: ${{ jobs.docker-build-push.outputs.image }}
      image-tag:
        description: Resulting image tag which can be used in dependent jobs
        value: ${{ jobs.docker-build-push.outputs.image-tag }}

permissions:
  contents: read # required for checkout
  packages: write # required for pushing images to GHCR
  pull-requests: write # required for creating and updating PR comments

jobs:
  docker-build-push:
    name: Docker Build and Push
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.image-tag.outputs.image }}
      image-tag: ${{ steps.image-tag.outputs.image-tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Set up Docker Buildx
        id: docker-buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Log in to GHCR
        if: inputs.push
        uses: docker/login-action@v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Metadata
        id: docker-metadata
        uses: docker/metadata-action@v5.8.0
        with:
          images: ${{ inputs.images }}
          tags: ${{ inputs.tag-rules }}

      - name: Docker Build and Push
        uses: docker/build-push-action@v6.18.0
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: linux/amd64
          builder: ${{ steps.docker-buildx.outputs.name }}
          # use github actions cache for faster builds
          # https://docs.docker.com/build/ci/github-actions/cache/
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: ${{ inputs.push }}
          tags: ${{ steps.docker-metadata.outputs.tags }}
          labels: ${{ steps.docker-metadata.outputs.labels }}

      - name: Create PR comment with pushed image tags
        if: github.event_name == 'pull_request' && inputs.pr-comment && inputs.push
        uses: peter-evans/create-or-update-comment@v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Image tags pushed:
            ```text
            ${{ steps.docker-metadata.outputs.tags }}
            ```

      - name: Debug Output
        run: |
          echo "Docker Metadata outputs: ${{ toJson(steps.docker-metadata.outputs) }}"

      # output image tag for this GHA run, which can be used in dependent jobs
      # the highest priority tag of the docker-metadata tag rules is used
      # this output is sent to the job output, which is sent to the workflow output
      # use it in another job with "needs.<job-name>.outputs.image-tag"
      # TODO update desc and stuff
      - name: Output image tag
        id: image-tag
        if: inputs.push
        run: |
          echo "image=${{ steps.docker-metadata.outputs.json.tags[0] }}" >> $GITHUB_OUTPUT
          echo "image-tag=${{ steps.docker-metadata.outputs.version }}" >> $GITHUB_OUTPUT
